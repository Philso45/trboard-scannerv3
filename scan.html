<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scanner Ticket Restaurant</title>
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <style>
    body { font-family: Arial; text-align: center; background:#f9f9f9; margin:0; padding:20px;}
    video { width:100%; max-width:400px; border:2px solid #333; border-radius:10px; }
    #scan-area { position:absolute; top:40%; left:15%; width:70%; height:20%; border:2px dashed red; pointer-events:none;}
    #scanner-container { position:relative; display:inline-block; }
    #result { margin-top:20px; font-size:1.2em; color:#333; }
  </style>
</head>
<body>
<h1>Scanner Ticket Restaurant</h1>
<div id="scanner-container">
  <video id="video" playsinline></video>
  <div id="scan-area"></div>
</div>
<div id="result">Passez le code-barres devant la caméra...</div>

<script>
const codeReader = new ZXing.BrowserMultiFormatReader();
const videoElement = document.getElementById('video');
const resultElement = document.getElementById('result');

const emetteurs = [
  {prefix:"4270", name:"Edenred"},
  {prefix:"5399", name:"Sodexo"},
  {prefix:"5000", name:"UP"},
  {prefix:"7000", name:"Swile"}
];

function decodeTicket(code){
  if(code.length !== 20) return {emetteur:"Inconnu", montant:"0,00", annee:"Inconnue"};
  let emetteur = "Inconnu";
  for(let e of emetteurs){
    if(code.startsWith(e.prefix)) emetteur=e.name;
  }
  const euros = parseInt(code.slice(12,14));
  const centimes = parseInt(code.slice(14,16));
  const montant = `${euros},${centimes.toString().padStart(2,'0')} €`;
  const annee = code.slice(16,20);
  return {emetteur, montant, annee};
}

// Scanner vidéo live
codeReader.listVideoInputDevices()
.then(videoInputDevices=>{
  if(videoInputDevices.length===0){ resultElement.textContent="Aucune caméra détectée"; return;}
  let backCamera = videoInputDevices.find(d=>d.label.toLowerCase().includes("back")||d.label.toLowerCase().includes("environment"));
  const deviceId = backCamera ? backCamera.deviceId : videoInputDevices[0].deviceId;

  codeReader.decodeFromVideoDevice(deviceId, videoElement, (result, err)=>{
    if(result){
      const info = decodeTicket(result.text);
      resultElement.innerHTML = `<strong>Émetteur :</strong> ${info.emetteur}<br>
                                 <strong>Montant :</strong> ${info.montant}<br>
                                 <strong>Année :</strong> ${info.annee}`;
      if(navigator.vibrate) navigator.vibrate(200); // vibration

      // Stop caméra
      codeReader.reset();

      // Retour page précédente après 0.5s
      setTimeout(()=>window.history.back(),500);
    }
    if(err && !(err instanceof ZXing.NotFoundException)){
      console.error(err);
    }
  });
})
.catch(err=>{ console.error(err); resultElement.textContent="Impossible d'accéder à la caméra"; });
</script>
</body>
</html>
