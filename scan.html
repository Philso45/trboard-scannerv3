<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Tickets Restaurant</title>
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 500px;
            overflow: hidden;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #2575fc;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .instructions {
            background-color: #f0f7ff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .scanner-container {
            width: 100%;
            height: 300px;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            border: 2px solid #2575fc;
        }
        
        #reader {
            width: 100%;
            height: 100%;
        }
        
        .scan-line {
            position: absolute;
            height: 2px;
            width: 100%;
            background: #2575fc;
            top: 50%;
            animation: scan 2s linear infinite;
        }
        
        @keyframes scan {
            0% { top: 10%; }
            50% { top: 90%; }
            100% { top: 10%; }
        }
        
        .result-container {
            display: none;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .result-item {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #e8f4ff;
            border-radius: 8px;
        }
        
        .ticket-list {
            width: 100%;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .ticket-item {
            background-color: #f0f7ff;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
        }
        
        .button {
            background: #2575fc;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 15px;
            width: 100%;
            transition: all 0.3s;
        }
        
        .button:hover {
            background: #1c64e0;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .success-sound {
            display: none;
        }
        
        .scanner-status {
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
            color: #2575fc;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #2575fc;
            margin-bottom: 20px;
        }
        
        .history-title {
            margin-top: 20px;
            margin-bottom: 10px;
            color: #2575fc;
            font-size: 18px;
            border-bottom: 2px solid #2575fc;
            padding-bottom: 5px;
        }
        
        .camera-switch {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        
        .switch-button {
            background: #6a11cb;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            margin: 0 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">üçΩÔ∏è TR Scanner</div>
            <h1>Scanner de Tickets Restaurant</h1>
            <div class="instructions">
                Placez le code-barres du ticket restaurant dans le cadre de scan. L'application d√©tectera automatiquement le code et enregistrera les informations.
            </div>
        </header>
        
        <div class="scanner-status" id="scannerStatus">Scanner pr√™t...</div>
        
        <div class="scanner-container">
            <div id="reader"></div>
            <div class="scan-line"></div>
        </div>
        
        <div class="camera-switch">
            <button class="switch-button" id="switchCamera">Changer de cam√©ra</button>
        </div>
        
        <button class="button" id="toggleScanner">D√©marrer le Scanner</button>
        
        <div class="result-container" id="resultContainer">
            <h2>Ticket scann√© avec succ√®s!</h2>
            <div class="result-item" id="amountResult">Montant: </div>
            <div class="result-item" id="emitterResult">√âmetteur: </div>
        </div>
        
        <div class="history-title">Historique des scans</div>
        <div class="ticket-list" id="ticketList">
            <!-- Les tickets scann√©s appara√Ætront ici -->
        </div>
        
        <audio class="success-sound" id="successSound" src="https://assets.mixkit.co/sfx/preview/mixkit-game-ball-tap-2073.mp3"></audio>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const scannerContainer = document.getElementById('reader');
            const toggleScannerBtn = document.getElementById('toggleScanner');
            const switchCameraBtn = document.getElementById('switchCamera');
            const resultContainer = document.getElementById('resultContainer');
            const amountResult = document.getElementById('amountResult');
            const emitterResult = document.getElementById('emitterResult');
            const ticketList = document.getElementById('ticketList');
            const successSound = document.getElementById('successSound');
            const scannerStatus = document.getElementById('scannerStatus');
            
            let html5QrcodeScanner = null;
            let isScanning = false;
            let scannedTickets = JSON.parse(localStorage.getItem('scannedTickets')) || [];
            let backCamera = true; // Utiliser la cam√©ra arri√®re par d√©faut
            let currentCameraId = null;
            
            // Afficher l'historique des tickets scann√©s
            function updateTicketList() {
                ticketList.innerHTML = '';
                scannedTickets.forEach(ticket => {
                    const ticketElement = document.createElement('div');
                    ticketElement.className = 'ticket-item';
                    ticketElement.innerHTML = `
                        <div>${ticket.emitter}</div>
                        <div>${ticket.amount} ‚Ç¨</div>
                    `;
                    ticketList.appendChild(ticketElement);
                });
            }
            
            updateTicketList();
            
            // Obtenir l'ID de la cam√©ra arri√®re
            async function getBackCameraId() {
                try {
                    const devices = await Html5Qrcode.getCameras();
                    for (const device of devices) {
                        if (device.label.toLowerCase().includes('back') || 
                            device.label.toLowerCase().includes('arri√®re') ||
                            device.label.toLowerCase().includes('rear')) {
                            return device.id;
                        }
                    }
                    // Si aucune cam√©ra arri√®re n'est trouv√©e, utiliser la premi√®re cam√©ra
                    return devices[0]?.id || null;
                } catch (err) {
                    console.error("Erreur lors de l'acc√®s aux cam√©ras:", err);
                    return null;
                }
            }
            
            // Fonction pour traiter les donn√©es du code-barres
            function processBarcodeData(data) {
                if (data.length < 20) {
                    scannerStatus.textContent = "Code-barres invalide";
                    return null;
                }
                
                // Extraire les caract√®res 13 √† 16 (index 12 √† 15)
                const amountDigits = data.substring(12, 16);
                // Convertir en d√©cimal avec 2 chiffres apr√®s la virgule
                const amount = (parseInt(amountDigits) / 100).toFixed(2).replace('.', ',');
                
                // Extraire les caract√®res 17 √† 18 (index 16 √† 17)
                const emitterCode = parseInt(data.substring(16, 18));
                let emitter = "Inconnu";
                
                // D√©terminer l'√©metteur selon les sp√©cifications
                if (emitterCode < 10) {
                    emitter = "Edenred";
                } else if (emitterCode < 20) {
                    emitter = "Up D√©jeuner";
                } else if (emitterCode < 30) {
                    emitter = "Pluxee";
                } else if (emitterCode < 40) {
                    emitter = "Autre √©metteur";
                }
                
                return { amount, emitter, code: data };
            }
            
            // D√©marrer le scanner
            async function startScanner() {
                if (!isScanning) {
                    try {
                        // Obtenir l'ID de la cam√©ra arri√®re
                        if (backCamera) {
                            currentCameraId = await getBackCameraId();
                        }
                        
                        html5QrcodeScanner = new Html5QrcodeScanner(
                            "reader", 
                            { 
                                fps: 10, 
                                qrbox: { width: 250, height: 150 },
                                supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_QR_CODE, Html5QrcodeScanType.SCAN_TYPE_BARCODE]
                            },
                            false
                        );
                        
                        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
                        isScanning = true;
                        toggleScannerBtn.textContent = "Arr√™ter le Scanner";
                        scannerStatus.textContent = "En cours de scan...";
                        scannerStatus.style.color = "#2575fc";
                    } catch (err) {
                        console.error("Erreur lors du d√©marrage du scanner:", err);
                        scannerStatus.textContent = "Erreur: Impossible d'acc√©der √† la cam√©ra";
                        scannerStatus.style.color = "#ff4d4d";
                    }
                }
            }
            
            // Arr√™ter le scanner
            function stopScanner() {
                if (isScanning && html5QrcodeScanner) {
                    html5QrcodeScanner.clear().then(() => {
                        isScanning = false;
                        toggleScannerBtn.textContent = "D√©marrer le Scanner";
                        scannerStatus.textContent = "Scanner arr√™t√©";
                        scannerStatus.style.color = "#ff4d4d";
                    }).catch(err => {
                        console.error("Erreur lors de l'arr√™t du scanner:", err);
                    });
                }
            }
            
            // Changer de cam√©ra
            async function switchCamera() {
                if (isScanning) {
                    stopScanner();
                    backCamera = !backCamera;
                    setTimeout(startScanner, 500);
                } else {
                    backCamera = !backCamera;
                }
            }
            
            // G√©rer le succ√®s du scan
            function onScanSuccess(decodedText, decodedResult) {
                const ticketData = processBarcodeData(decodedText);
                
                if (ticketData) {
                    // Jouer le son de succ√®s
                    successSound.play();
                    
                    // Afficher les r√©sultats
                    amountResult.textContent = `Montant: ${ticketData.amount} ‚Ç¨`;
                    emitterResult.textContent = `√âmetteur: ${ticketData.emitter}`;
                    resultContainer.style.display = 'block';
                    
                    // Sauvegarder le ticket
                    scannedTickets.push(ticketData);
                    localStorage.setItem('scannedTickets', JSON.stringify(scannedTickets));
                    updateTicketList();
                    
                    // Arr√™ter le scanner et pr√©parer la fermeture
                    stopScanner();
                    scannerStatus.textContent = "Ticket scann√© avec succ√®s!";
                    scannerStatus.style.color = "#4caf50";
                    
                    // Fermer automatiquement apr√®s 2 secondes
                    setTimeout(() => {
                        // Simuler la fermeture de la page (dans un environnement r√©el, cela fermerait la fen√™tre)
                        alert("Scan r√©ussi! Vous pouvez maintenant retourner √† l'application Glide.");
                    }, 2000);
                } else {
                    scannerStatus.textContent = "Erreur de traitement du code-barres";
                    scannerStatus.style.color = "#ff4d4d";
                }
            }
            
            // G√©rer l'√©chec du scan
            function onScanFailure(error) {
                // Les erreurs sont normales pendant le scan, donc on ne les affiche pas toutes
            }
            
            // Bouton pour d√©marrer/arr√™ter le scanner
            toggleScannerBtn.addEventListener('click', function() {
                if (isScanning) {
                    stopScanner();
                } else {
                    startScanner();
                }
            });
            
            // Bouton pour changer de cam√©ra
            switchCameraBtn.addEventListener('click', switchCamera);
            
            // D√©marrer automatiquement le scanner au chargement de la page
            startScanner();
        });
    </script>
</body>
</html>
